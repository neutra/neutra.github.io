<!DOCTYPE html>
          <head>
        <meta charset="utf-8">
            
            <title>
                支付宝WAP支付接口开发 | f•ﻌ•l
            </title>
            <meta content="width=device-width, initial-scale=1" name="viewport">
            <meta name="theme-color" content="#4184f3">
            
            
            <link href="/favicon.ico" rel="icon"/>
            

            <link rel="stylesheet" href="/css/highlight.light.css">
            <link rel="stylesheet" href="/css/prism-customize.css">
            <link rel="stylesheet" href="/css/nav-icon.css">
            <link rel="stylesheet" href="/css/waves.min.css">
            <link rel="stylesheet" href="/css/jquery.tocify.css">
            <link rel="stylesheet" href="/css/main.css">
            <link rel="stylesheet" href="/css/nav-indicator.css">
            
  

  
            </meta>
        </meta>
    </head>

    <body>
        <header>
            <!-- cover image or sth. -->
        </header>
        <div id="main" class="m-scene">
            
<div class="nav-wrapper">

    <div class="container">
        <nav>
            <div class="logo wave">
                <a href="/" id="logo">
                    f•ﻌ•l
                </a>
            </div>
            <div class="nav-toggle-icon" >
                <div class="material-hamburger">
                    <span>
                    </span>
                    <span>
                    </span>
                    <span>
                    </span>
                </div>
            </div>
            <div class="menu-wrapper">
                <div class="nav-indicator">
                </div>
                <ul class="menus">
                    
                     
                        <li>
                            <a class="wave " href="/">
                                首页
                            </a>
                        </li>
                     
                        <li>
                            <a class="wave " href="/archives">
                                归档
                            </a>
                        </li>
                     
                        <li>
                            <a class="wave " href="/about">
                                关于
                            </a>
                        </li>
                     
                        <li>
                            <a class="wave no-smoothstate" href="/atom.xml">
                                订阅
                            </a>
                        </li>
                     
                    
                   
                </ul>
            </div>
        </nav>
    </div>
</div>
            <div class="container content">
                <div class="scene_element scene_element--fadein">
                    <div class="row">
    <div class="main">
        <article>
          
          <header class="post-header">
          
          </header>
          <h1 class="post-title">支付宝WAP支付接口开发</h1>

          <section class="post-info">
            <span class="post-date">2013/07/02</span>
            
            <span class="post-category">
                <a class="article-category-link" href="/categories/back-end/">back-end</a>
            </span>
            
            
            <span class="post-tags">
              <ul class="post-tag-list"><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/node-js/">node.js</a></li><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/支付宝/">支付宝</a></li></ul>
            </span>
            
          </section>

          <section class="post-content">
            <p>因项目需要，要增加支付宝手机网站支付功能，找了支付宝的样例代码和接口说明，折腾两天搞定，谨以此文作为这两天摸索的总结。由于公司有自己的支付接口，并不直接使用这个接口，所以晚些时候打算把测试代码整理好放到Github上。</p>
<h2 id="1-开发前准备"><a href="/2013/支付宝WAP支付接口开发/#1-开发前准备" class="headerlink" title="1. 开发前准备"></a>1. 开发前准备</h2><blockquote>
<ol>
<li><p>到官网了解此接口的信息，下载样例代码（只有ASP.NET和PHP）以便随时参考。</p>
</li>
<li><p>一个通过实名认证的企业支付宝账号，并申请开通手机WAP支付功能，我的测试账号是拿公司的，申请流程不清楚，官网有说怎么申请，各位各显神通吧。</p>
</li>
<li><p>公网域名和node.js环境。下面的代码大多用coffee来表达，不过本文不会贴太多代码，即使对coffee不熟悉也没什么关系。关于coffee可以参考这里。</p>
</li>
</ol>
</blockquote>
<p>github上有两个开源小项目（搜索 alipay ），但都没有WAP支付功能，可以拿来当参考，可以认为是示例代码的js移植版，结构很相像。我原打算在其中一个项目基础上继续开发，看了代码和接口文档后，还是决定从头开发一个。因为原有代码层次不够清晰，有点过度设计的感觉，而且支付宝的接口很简单，重写工作量不大。</p>
<p>吐槽下： 官网的示例代码真只是示例级(test)而已，跟产品级(production)还隔比较远，感觉还谈不上SDK。接口文档相当的坑爹，正因如此我才觉得有必要好好写篇文章总结。</p>
<h2 id="2-流程"><a href="/2013/支付宝WAP支付接口开发/#2-流程" class="headerlink" title="2. 流程"></a>2. 流程</h2><p>接口开发最重要的应该是理解数据交互流程了，流程弄清了，并理解为何这么设计，开发起来也是事半功倍</p>
<p>首先，要准备下面几个参数：</p>
<blockquote>
<ol>
<li><p>企业支付宝账号的PID(也叫ParnerID)和KEY，如果使用RSA签名而不是MD5的话，还要把RSA私钥准备好</p>
</li>
<li><p>支付时用户看到的东西：商品名称(subject)、支付总额（total_fee）、购买数量（通常都是1吧）</p>
</li>
<li><p>交易后的跳转地址，交易成功后用户可以手工点击，或页面延迟自动跳转到这个地址(return_url)</p>
</li>
<li><p>交易状态异步通知地址，交易成功或交易关闭会把消息POST到这个地址(notify_url)</p>
</li>
</ol>
</blockquote>
<p>然后，看这幅流程图（不错吧，推荐下这个网站:）</p>
<p><img src="http://neutra-blog-images.qiniudn.com/20130728121400.png" alt=""></p>
<blockquote>
<p>Alipay WAP pay flow</p>
<p>Browzer-&gt;+Site: 1. HTTP GET<br>note over Site: 2. create a new trade<br>Site-&gt;+Alipay: 3. create redirect<br>Alipay-&gt;-Site: 4. Token<br>note over Site: 5. build auth url<br>Site-&gt;-Browzer: 6. redirect to auth url<br>Browzer-&gt;Alipay: 7. redirect<br>Alipay-&gt;Browzer: 8. trade info<br>Browzer-&gt;Alipay: 9. auth and pay<br>Alipay-&gt;+Site: 10. HTTP POST notify<br>note over Site: 11. process trade<br>Site-&gt;-Alipay: 12. reply “success”<br>Alipay-&gt;Browzer: 13. pay success<br>Browzer-&gt;Site: 14. goto return url</p>
</blockquote>
<p>这个流程图基本囊括了整个交互过程，下面是说明:</p>
<blockquote>
<ol>
<li>用户点击购买按钮（或其他形式），向网站发起购买请求</li>
<li>网站创建订单，指派一个唯一订单号</li>
<li>网站把订单号、企业支付宝账号、交易金额、数量等信息，用私钥&gt; 签名发送给支付宝</li>
<li>支付宝创建一个交易订单，返回一个交易令牌(token)</li>
<li>网站按照指定要求，用token和自己的私钥，构造一个重定向得&gt; 到支付地址</li>
<li>网站把重定向地址返回给浏览器</li>
<li>浏览器自动重定向到该地址，即包含了token、网站签名的支付宝&gt; 交易页面</li>
<li>支付宝显示当前交易金额、数量、卖家等信息</li>
<li>用户用自己的支付宝账号支付这笔金额</li>
<li>支付宝把用户支付成功（或失败）这个消息和订单号加上支付宝&gt; 的签名，使用HTTP POST的方式通知网站（失败的话，会隔段时间重新发送）</li>
<li>网站处理交易后续逻辑（发货、订单状态存储之类的）</li>
<li>网站返回”success”字符串给支付宝，表示该通知已经处理，不&gt; 用再重发</li>
<li>支付宝显示支付成功页面给用户（这一步和第10步是不分先后发&gt; 生的）</li>
<li>支付成功页面延迟自动跳转，或用户点击“返回商户页面”，跳转&gt; 到网站的支付结束页面（此时不一定成功处理支付宝发来的通知&gt; ），但会在URL带上当前的订单号和状态。</li>
</ol>
</blockquote>
<p>可以发现，整个流程有点像OAuth（哎呀，之前那篇文章还没写&gt; 完呢！），主要分三步：</p>
<p>一是申请支付宝交易号（获取token），这一步可以理解为，让支付宝验证网站的有效性、让网站指定该交易要支付多少钱 二是用户到支付宝页面付款，这一步可以理解为，让支付宝验证用户有效性，让用户在一个不受网站监视的环境下进行支付 三是用户付款后，处理结果页面告诉用户支付成功（同步通知），另外异步通知网站服务器该订单已支付。</p>
<p>支付宝的接口文档说只有两个步骤，感觉不是很好理解，三步还是比较准确的（收钱肯定要办事的嘛）。</p>
<p>好困，细节问题下期继续。。。</p>
<hr>
<p>2013-07-24</p>
<h2 id="3-细节"><a href="/2013/支付宝WAP支付接口开发/#3-细节" class="headerlink" title="3. 细节"></a>3. 细节</h2><h3 id="3-1-网站向支付宝申请新订单"><a href="/2013/支付宝WAP支付接口开发/#3-1-网站向支付宝申请新订单" class="headerlink" title="3.1 网站向支付宝申请新订单"></a>3.1 网站向支付宝申请新订单</h3><p>网站的订单系统先产生一个新订单，然后请求支付宝创建一个支付宝订单.</p>
<p>申请新订单的service是 alipay.wap.trade.create.direct 需要提交的关键参数包括：</p>
<h4 id="3-1-1-用户在支付宝看到的订单信息："><a href="/2013/支付宝WAP支付接口开发/#3-1-1-用户在支付宝看到的订单信息：" class="headerlink" title="3.1.1 用户在支付宝看到的订单信息："></a>3.1.1 用户在支付宝看到的订单信息：</h4><blockquote>
<p>subject: 商品名称<br>total_fee: 总金额<br>seller_account_name: 卖家支付宝账号（估计跟私钥绑定的）<br>merchant_url: 商品展示URL（似乎这个并非必要)</p>
</blockquote>
<h4 id="3-1-2-支付宝通知网站时将附带的信息："><a href="/2013/支付宝WAP支付接口开发/#3-1-2-支付宝通知网站时将附带的信息：" class="headerlink" title="3.1.2 支付宝通知网站时将附带的信息："></a>3.1.2 支付宝通知网站时将附带的信息：</h4><blockquote>
<p>out_trade_no: 该次交易对应网站的订单号（要求唯一）<br>call_back_url: 交易成功后，支付宝页面上“返回到商家页面”的地址（同步回调）<br>notify_url: 交易状态变更后，支付宝通知网站的回调地址（异步通知）</p>
</blockquote>
<p>支付宝验证通过后，将返回新创建的支付宝订单号，网站可将该订单号与自己订单系统的的订单号绑定在一起。支付宝同时返回的还有该次交易的token，用于(3.2)用户支付。</p>
<h3 id="3-2-用户在支付宝网站，查看订单消息，通过验证并支付"><a href="/2013/支付宝WAP支付接口开发/#3-2-用户在支付宝网站，查看订单消息，通过验证并支付" class="headerlink" title="3.2 用户在支付宝网站，查看订单消息，通过验证并支付"></a>3.2 用户在支付宝网站，查看订单消息，通过验证并支付</h3><p>网站返回跳转到支付宝的地址，service是alipay.wap.auth.authAndExecute，包含(3.1)返回的token和网站对跳转地址的签名</p>
<p>这是个HTTPS页面，基本认为是安全的。当然前提是浏览器没被动手脚，安卓不少应用被捆绑广告那是常有的事，手机浏览器对HTTPS也不像PC那样有明显提示，这些也是我不怎么信任手机支付的原因。</p>
<p>用户跳转到支付宝页面后，可以在该页面里看到当前支付的订单的名称和金额，这些是3.1申请时由网站指定的，让用户在支付宝的页面确认一次再付款是合理的。</p>
<h3 id="3-3-支付宝通知网站支付成功，网站收钱做事"><a href="/2013/支付宝WAP支付接口开发/#3-3-支付宝通知网站支付成功，网站收钱做事" class="headerlink" title="3.3 支付宝通知网站支付成功，网站收钱做事"></a>3.3 支付宝通知网站支付成功，网站收钱做事</h3><p>这个过程是支付宝通知网站，网站处理后通知用户已到账，共包括两个并行部分：</p>
<h4 id="3-3-1-异步通知"><a href="/2013/支付宝WAP支付接口开发/#3-3-1-异步通知" class="headerlink" title="3.3.1 异步通知"></a>3.3.1 异步通知</h4><p>用户支付后，支付宝通过HTTP协议通知网站该订单交易结果。说白了就是支付宝悄悄地告诉网站“这个订单已经已经付款啦”</p>
<p>值得注意的是，异步通知有重发机制，支付宝需要得到响应为”success”才认为该通知成功被接收，否则会间隔一段时间重发，依次间隔2m,10m,10m,1h,2h,6h,15h，最多8次通知，由notify_id说明是同一个通知。8次通知都接收失败怎么办？额orz…文档没说，用那个支付宝订单号登录支付宝去查账吧。</p>
<h4 id="3-3-2-同步通知"><a href="/2013/支付宝WAP支付接口开发/#3-3-2-同步通知" class="headerlink" title="3.3.2 同步通知"></a>3.3.2 同步通知</h4><p>用户支付后，支付宝页面提示“支付成功”，可点击返回商家页面，也可等待一段时间自动跳回</p>
<p>个人认为，网站跳到这个页面后，如果仍未收到(3.3.1)异步通知，并且使用的是MD5签名，应该把状态从“待付款”调整为“等待对账”，而不应该贸然相信该通知的结果。原因是这个回调地址用户是可以知道的，MD5签名还是有被伪造的可能(4.3)。当然额外再做个token之类的理论上也行（需要放在urlpath而不是querystring）。</p>
<p>假如接口调用出错，通知是不会签名的。不签名的原因我怀疑是防止有人恶意收集请求-签名样本，见(4.3)。</p>
<h2 id="4-签名与加密"><a href="/2013/支付宝WAP支付接口开发/#4-签名与加密" class="headerlink" title="4. 签名与加密"></a>4. 签名与加密</h2><p>简单的说，签名防篡改，加密防窃听。上面的两种请求(3.1和3.2)和两个通知(3.3.1和3.3.2)都被要加签名，支付宝支持下面两类签名：</p>
<h3 id="4-1-MD5-业务数据不加密，防篡改"><a href="/2013/支付宝WAP支付接口开发/#4-1-MD5-业务数据不加密，防篡改" class="headerlink" title="4.1 MD5: 业务数据不加密，防篡改"></a>4.1 MD5: 业务数据不加密，防篡改</h3><p>优点: 相对较简单（当然是相对DSA/RSA来说），计算速度快，明文更直观</p>
<p>缺点: 可抵赖，可能被窃听、安全性不如非对称加密</p>
<h3 id="4-2-DSA-RSA-业务数据加密，也防篡改"><a href="/2013/支付宝WAP支付接口开发/#4-2-DSA-RSA-业务数据加密，也防篡改" class="headerlink" title="4.2 DSA/RSA: 业务数据加密，也防篡改"></a>4.2 DSA/RSA: 业务数据加密，也防篡改</h3><p>优点：不可抵赖，安全性较高</p>
<p>缺点：相对较复杂，解密速度慢</p>
<p>一开始我想不懂，支付宝既然支持RSA为何还要支持MD5，后来有人说RSA太慢，想想支付宝的业务量就释然了。由于每个商家的私钥都不同，并且跟商家的支付宝账号绑定，即使商家的私钥被破解了，用户支付时HTTPS协议基本可以保证用户支付的目标还是商家的账号。</p>
<h3 id="4-3-使用MD5签名可能存在的风险"><a href="/2013/支付宝WAP支付接口开发/#4-3-使用MD5签名可能存在的风险" class="headerlink" title="4.3 使用MD5签名可能存在的风险"></a>4.3 使用MD5签名可能存在的风险</h3><p>以下情景仅是我的推断，没有尝试过，所谓道高一尺魔高一丈，希望读者也别以身犯险。</p>
<p>在用户支付的步骤(3.2)和支付成功响应页面(3.3)，用户可以得到一个明文请求内容和对应签名。由于网站和支付宝直接通信共用同一个密钥，一般长期不变，双方都可以对同一段数据产生签名，这就有可能抵赖的风险：</p>
<p>网站：“这个数据是你发过来的，上面有你的签名。”</p>
<p>支付宝：“不是我发的。这个数据是你伪造的，签名是你签的。”</p>
<p>另外，当攻击者收集到足够多的样本，是有可能破解出密钥的，继而可伪造网站或支付宝任意一方。</p>
<h4 id="4-3-1-恶意消耗商家的订单号"><a href="/2013/支付宝WAP支付接口开发/#4-3-1-恶意消耗商家的订单号" class="headerlink" title="4.3.1 恶意消耗商家的订单号"></a>4.3.1 恶意消耗商家的订单号</h4><p>攻击者伪造大量未使用的订单号（不少网站的订单号都是递增的纯数字，并公开给用户，且很容易推测到后面的数字），向支付宝请求订单，直到超时。由于商家对此并不知情（回调地址和通知地址均篡改掉），其他用户下单时假如商家用了被伪造过的订单号，就可能被支付宝认为提交了重复订单，结果支付失败。</p>
<h4 id="4-3-2-欺骗商家已支付订单"><a href="/2013/支付宝WAP支付接口开发/#4-3-2-欺骗商家已支付订单" class="headerlink" title="4.3.2 欺骗商家已支付订单"></a>4.3.2 欺骗商家已支付订单</h4><p>由同步通知(3.3.2)返回的参数可以看到，网站订单标识和交易token和都是可以得到的。这样的话，关于步骤(3.1)，用户不知道的参数包括notify_url和out_user_no，假如网站的用户id本身就是公开的，通知回调地址（3.3.1）被得知或同步通知（3.3.2）实现的不好，就可以通过伪造支付通知，欺骗商家订单已支付。</p>
<p>待续，下期补充实现代码</p>
<hr>
<p>2013-07-28</p>
<h2 id="5-代码"><a href="/2013/支付宝WAP支付接口开发/#5-代码" class="headerlink" title="5. 代码"></a>5. 代码</h2><h3 id="5-1-签名"><a href="/2013/支付宝WAP支付接口开发/#5-1-签名" class="headerlink" title="5.1 签名"></a>5.1 签名</h3><p>我只做了MD5签名，项目里没用到RSA签名，就没做那方面。按照文档说明和demo源代码，很容易就可以写出下面的签名代码：</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">getSign</span> = <span class="params">(obj,key)</span> -&gt;</span></div><div class="line">	<span class="keyword">return</span> <span class="literal">null</span> <span class="keyword">unless</span> obj</div><div class="line">	arr = ([k,v] <span class="keyword">for</span> k,v <span class="keyword">of</span> obj <span class="keyword">when</span> k <span class="keyword">isnt</span> <span class="string">'sign'</span> <span class="keyword">and</span> v? <span class="keyword">and</span> v <span class="keyword">isnt</span> <span class="string">''</span>)</div><div class="line">	arr.sort()</div><div class="line">	src = (<span class="string">"<span class="subst">#&#123;i[<span class="number">0</span>]&#125;</span>=<span class="subst">#&#123;i[<span class="number">1</span>]&#125;</span>"</span> <span class="keyword">for</span> i <span class="keyword">in</span> arr).join <span class="string">'&amp;'</span></div><div class="line">	src = <span class="string">"<span class="subst">#&#123;src&#125;</span><span class="subst">#&#123;key&#125;</span>"</span></div><div class="line">	crypto.createHash(<span class="string">'md5'</span>).update(src,<span class="string">'utf8'</span>).digest <span class="string">'hex'</span></div></pre></td></tr></table></figure>
<p>支付宝发到网站的通知(3.3)的签名算法跟上面有点不一样，文档有这么段说明：</p>
<p><img src="http://neutra-blog-images.qiniudn.com/20130728094842.png" alt=""></p>
<p>这里说要按通知的参数的原本顺序计算签名。所以我就把上面的arr.sort()去掉然后计算签名，结果发通知发来的签名和我自己计算的不一致，纠结半天后仔细看文档的样例说明，看到下面段：</p>
<p><img src="http://neutra-blog-images.qiniudn.com/20130728094218.png" alt=""></p>
<p>仔细跟实际接收的数据比较之后发现，文档和样例都说发来的参数顺序是(service,v,sec_id,notify_data)，但我实际收到的并不是按这个顺序，只要按照文档的参数顺序重新排列再计算签名就正确了，最终通知的签名算法如下( 真是个蛋疼的大坑orz)：</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">getNotitySign</span> = <span class="params">(obj,key)</span> -&gt;</span></div><div class="line">	<span class="keyword">return</span> <span class="literal">null</span> <span class="keyword">unless</span> obj</div><div class="line">	src = (<span class="string">"<span class="subst">#&#123;k&#125;</span>=<span class="subst">#&#123;obj[k]&#125;</span>"</span> <span class="keyword">for</span> k <span class="keyword">in</span> [<span class="string">"service"</span>,<span class="string">"v"</span>,<span class="string">"sec_id"</span>,<span class="string">"notify_data"</span>]).join <span class="string">'&amp;'</span></div><div class="line">	src = <span class="string">"<span class="subst">#&#123;src&#125;</span><span class="subst">#&#123;key&#125;</span>"</span></div><div class="line">	crypto.createHash(<span class="string">'md5'</span>).update(src,<span class="string">'utf8'</span>).digest <span class="string">'hex'</span></div></pre></td></tr></table></figure>
<p>文档里有说到字符编码参数_input_charset，我用的是utf8编码，发现不用传这个参数也可以，看来支付宝默认的字符编码就是utf8了</p>
<p>如果使用RSA签名，需要先解密再计算签名</p>
<h3 id="5-2-辅助方法"><a href="/2013/支付宝WAP支付接口开发/#5-2-辅助方法" class="headerlink" title="5.2 辅助方法"></a>5.2 辅助方法</h3><p>为了代码层次更清晰，我把签名、url拼接等方法抽出到一个单独模块(alipay_api.coffee):</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line">api_url = <span class="string">"http://wappaygw.alipay.com/service/rest.htm"</span></div><div class="line">regexTokenXml = <span class="regexp">/&lt;request_token&gt;(.*)&lt;\/request_token&gt;/</span></div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = api = </div><div class="line"></div><div class="line">	services:</div><div class="line">		create: <span class="string">"alipay.wap.trade.create.direct"</span></div><div class="line">		auth: <span class="string">"alipay.wap.auth.authAndExecute"</span></div><div class="line"></div><div class="line">	toReqData: <span class="function"><span class="params">(name,obj)</span> -&gt;</span></div><div class="line">		arr = [<span class="string">"&lt;<span class="subst">#&#123;name&#125;</span>&gt;"</span>]</div><div class="line">		arr.push <span class="string">"&lt;<span class="subst">#&#123;k&#125;</span>&gt;<span class="subst">#&#123;v&#125;</span>&lt;/<span class="subst">#&#123;k&#125;</span>&gt;"</span> <span class="keyword">for</span> k,v <span class="keyword">of</span> obj</div><div class="line">		arr.push <span class="string">"&lt;/<span class="subst">#&#123;name&#125;</span>&gt;"</span></div><div class="line">		arr.join <span class="string">''</span></div><div class="line"></div><div class="line">	createReq: <span class="function"><span class="params">(service,partner,req_data)</span> -&gt;</span> </div><div class="line">		service : service</div><div class="line">		format  : <span class="string">'xml'</span></div><div class="line">		v       : <span class="string">'2.0'</span></div><div class="line">		partner : partner</div><div class="line">		sec_id  : <span class="string">'MD5'</span></div><div class="line">		sign    : <span class="literal">null</span></div><div class="line">		req_data: req_data</div><div class="line"></div><div class="line">	parseTokenFromXml: <span class="function"><span class="params">(xml)</span> -&gt;</span></div><div class="line">		<span class="keyword">return</span> <span class="literal">null</span> <span class="keyword">unless</span> xml</div><div class="line">		m = regexTokenXml.exec xml</div><div class="line">		m?[<span class="number">1</span>]?.trim()</div><div class="line"></div><div class="line">	getSign: <span class="function"><span class="params">(obj,key=<span class="string">''</span>)</span> -&gt;</span></div><div class="line">		<span class="keyword">return</span> <span class="literal">null</span> <span class="keyword">unless</span> obj</div><div class="line">		arr = ([k,v] <span class="keyword">for</span> k,v <span class="keyword">of</span> obj <span class="keyword">when</span> k <span class="keyword">isnt</span> <span class="string">'sign'</span> <span class="keyword">and</span> v? <span class="keyword">and</span> v <span class="keyword">isnt</span> <span class="string">''</span>)</div><div class="line">		arr.sort()</div><div class="line">		src = (<span class="string">"<span class="subst">#&#123;i[<span class="number">0</span>]&#125;</span>=<span class="subst">#&#123;i[<span class="number">1</span>]&#125;</span>"</span> <span class="keyword">for</span> i <span class="keyword">in</span> arr).join <span class="string">'&amp;'</span></div><div class="line">		src = <span class="string">"<span class="subst">#&#123;src&#125;</span><span class="subst">#&#123;key&#125;</span>"</span></div><div class="line">		crypto.createHash(<span class="string">'md5'</span>).update(src,<span class="string">'utf8'</span>).digest <span class="string">'hex'</span></div><div class="line"></div><div class="line">	getNotitySign: <span class="function"><span class="params">(obj,key=<span class="string">''</span>)</span> -&gt;</span></div><div class="line">		<span class="keyword">return</span> <span class="literal">null</span> <span class="keyword">unless</span> obj</div><div class="line">		src = (<span class="string">"<span class="subst">#&#123;k&#125;</span>=<span class="subst">#&#123;obj[k]&#125;</span>"</span> <span class="keyword">for</span> k <span class="keyword">in</span> [<span class="string">"service"</span>,<span class="string">"v"</span>,<span class="string">"sec_id"</span>,<span class="string">"notify_data"</span>]).join <span class="string">'&amp;'</span></div><div class="line">		src = <span class="string">"<span class="subst">#&#123;src&#125;</span><span class="subst">#&#123;key&#125;</span>"</span></div><div class="line">		crypto.createHash(<span class="string">'md5'</span>).update(src,<span class="string">'utf8'</span>).digest <span class="string">'hex'</span></div><div class="line"></div><div class="line">	sendCreate: <span class="function"><span class="params">(req,done)</span> -&gt;</span></div><div class="line">		opt =</div><div class="line">			url: createCreateUrl req</div><div class="line">		request.get opt, <span class="function"><span class="params">(err,res,body)</span> -&gt;</span></div><div class="line">			<span class="keyword">return</span> done err <span class="keyword">if</span> err</div><div class="line">			body = <span class="string">""</span> <span class="keyword">unless</span> body</div><div class="line">			ret = querystring.parse body</div><div class="line">			body = <span class="literal">null</span></div><div class="line">			done <span class="literal">null</span>,ret</div><div class="line"></div><div class="line">	createAuthUrl: <span class="function"><span class="params">(token=<span class="string">''</span>,key=<span class="string">''</span>)</span> -&gt;</span></div><div class="line">		req = api.createReq api.services.auth</div><div class="line">		req.req_data = <span class="string">"&lt;auth_and_execute_req&gt;&lt;request_token&gt;<span class="subst">#&#123;token&#125;</span>&lt;/request_token&gt;&lt;/auth_and_execute_req&gt;"</span></div><div class="line">		req.sign = api.getSign req, <span class="literal">yes</span></div><div class="line">		createAuthUrl req</div><div class="line"><span class="function"></span></div><div class="line"><span class="title">createCreateUrl</span> = <span class="params">(req)</span> -&gt;</div><div class="line">	url = <span class="string">"<span class="subst">#&#123;api_url&#125;</span>?"</span></div><div class="line">	url += <span class="string">"req_data=<span class="subst">#&#123;encodeURIComponent req.req_data&#125;</span>"</span></div><div class="line">	url += <span class="string">"&amp;service=<span class="subst">#&#123;encodeURIComponent req.service&#125;</span>"</span></div><div class="line">	url += <span class="string">"&amp;sec_id=<span class="subst">#&#123;encodeURIComponent req.sec_id&#125;</span>"</span></div><div class="line">	url += <span class="string">"&amp;partner=<span class="subst">#&#123;encodeURIComponent req.partner&#125;</span>"</span></div><div class="line">	url += <span class="string">"&amp;req_id=<span class="subst">#&#123;encodeURIComponent req.req_id&#125;</span>"</span></div><div class="line">	url += <span class="string">"&amp;sign=<span class="subst">#&#123;encodeURIComponent req.sign&#125;</span>"</span></div><div class="line">	url += <span class="string">"&amp;format=<span class="subst">#&#123;encodeURIComponent req.format&#125;</span>"</span></div><div class="line">	url += <span class="string">"&amp;v=<span class="subst">#&#123;encodeURIComponent req.v&#125;</span>"</span></div><div class="line">	url</div><div class="line"><span class="function"></span></div><div class="line"><span class="title">createAuthUrl</span> = <span class="params">(req)</span> -&gt;</div><div class="line">	url = <span class="string">"<span class="subst">#&#123;api_url&#125;</span>?"</span></div><div class="line">	url += <span class="string">"req_data=<span class="subst">#&#123;encodeURIComponent req.req_data&#125;</span>"</span></div><div class="line">	url += <span class="string">"&amp;service=<span class="subst">#&#123;encodeURIComponent req.service&#125;</span>"</span></div><div class="line">	url += <span class="string">"&amp;sec_id=<span class="subst">#&#123;encodeURIComponent req.sec_id&#125;</span>"</span></div><div class="line">	url += <span class="string">"&amp;partner=<span class="subst">#&#123;encodeURIComponent req.partner&#125;</span>"</span></div><div class="line">	url += <span class="string">"&amp;sign=<span class="subst">#&#123;encodeURIComponent req.sign&#125;</span>"</span></div><div class="line">	url += <span class="string">"&amp;format=<span class="subst">#&#123;encodeURIComponent req.format&#125;</span>"</span></div><div class="line">	url += <span class="string">"&amp;v=<span class="subst">#&#123;encodeURIComponent req.v&#125;</span>"</span></div><div class="line">	url</div></pre></td></tr></table></figure>
<h3 id="5-3-业务部分"><a href="/2013/支付宝WAP支付接口开发/#5-3-业务部分" class="headerlink" title="5.3 业务部分"></a>5.3 业务部分</h3><h4 id="5-3-1-购买-buy"><a href="/2013/支付宝WAP支付接口开发/#5-3-1-购买-buy" class="headerlink" title="5.3.1 购买(buy)"></a>5.3.1 购买(buy)</h4><p>购买的逻辑对应于(2)流程图的(2,3,4,5)，创建唯一请求ID，填充本次交易信息，发送到支付宝并获取token，然后拼接支付url并签名，然后重定向。</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">demo.buy = <span class="function"><span class="params">(info,done)</span> -&gt;</span></div><div class="line">	<span class="keyword">return</span> done <span class="string">'bad user'</span> <span class="keyword">unless</span> info?.user_id?.length&gt;<span class="number">10</span></div><div class="line">	req = api.createReq api.services.create, info.partner</div><div class="line">	ret = </div><div class="line">		redirect: <span class="string">''</span></div><div class="line">		token: <span class="literal">null</span></div><div class="line">	async.series [</div><div class="line">		(cb) -&gt;</div><div class="line">			getRequestId req.service,<span class="function"><span class="params">(err,req_id)</span> -&gt;</span></div><div class="line">				req.req_id = req_id</div><div class="line">				cb err</div><div class="line">		(cb) -&gt;</div><div class="line">			createTrade info,req.req_id,<span class="function"><span class="params">(err, tradeId)</span> -&gt;</span></div><div class="line">				<span class="keyword">return</span> cb err <span class="keyword">if</span> err </div><div class="line">				req.req_data = </div><div class="line">					subject            : info.subject  <span class="comment"># 商品名称</span></div><div class="line">					out_trade_no       : tradeId.toString() <span class="comment"># 网站订单号</span></div><div class="line">					total_fee          : info.total_fee  <span class="comment"># 价钱(number)，单位元，例如 0.01 代表1分钱</span></div><div class="line">					seller_account_name: info.seller_account_name <span class="comment"># 支付宝账号</span></div><div class="line">					call_back_url      : info.call_back_url <span class="comment"># 支付成功后浏览器跳转地址</span></div><div class="line">					notify_url         : info.notify_url <span class="comment"># 支付成功支付宝的通知将异步发送到此地址</span></div><div class="line">					out_user           : info.user_id <span class="comment"># 网站的用户标识</span></div><div class="line">					merchant_url       : info.merchant_url <span class="comment"># 商品展示页面， 只是实际测试时(ios)发现支付时没地方可以跳到这个页面</span></div><div class="line">				req.pay_expire = info.pay_expire <span class="keyword">if</span> info.pay_expire? <span class="comment"># 支付过期时间</span></div><div class="line">				req.req_data = api.toReqData <span class="string">'direct_trade_create_req'</span>,req.req_data</div><div class="line">				req.sign = api.getSign req, info.key</div><div class="line">				cb <span class="literal">null</span></div><div class="line">		(cb) -&gt;</div><div class="line">			api.sendCreate req, <span class="function"><span class="params">(err,res)</span> -&gt;</span></div><div class="line">				<span class="keyword">return</span> cb err <span class="keyword">if</span> err </div><div class="line">				<span class="keyword">return</span> cb <span class="string">'bad sign from alipay server'</span> <span class="keyword">unless</span> req.sign <span class="keyword">is</span> api.getSign req</div><div class="line">				ret.token = api.parseTokenFromXml res.res_data</div><div class="line">				ret.redirect = api.createAuthUrl ret.token</div><div class="line">				storeTradeInfo req.out_trade_no, req.total_fee, ret.token, <span class="function"><span class="params">(err,success)</span> -&gt;</span></div><div class="line">					<span class="keyword">return</span> cb err <span class="keyword">if</span> err</div><div class="line">					cb <span class="keyword">if</span> success <span class="keyword">then</span> <span class="literal">null</span> <span class="keyword">else</span> <span class="string">'store trade info fail'</span></div><div class="line">	],<span class="function"><span class="params">(err)</span> -&gt;</span></div><div class="line">		done err, ret.redirect</div></pre></td></tr></table></figure>
<p>其中用到的几个方法跟存储相关，我用的是MySQL：</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">getRequestId</span> = <span class="params">(service, done)</span> -&gt;</span></div><div class="line">	sql = <span class="string">"insert into alipay_requests(service,create_time,state) values(?,now(),'CREATE')"</span> </div><div class="line">	db.queryAll sql,[service],<span class="function"><span class="params">(err,result)</span> -&gt;</span></div><div class="line">		done err, result?.insertId</div><div class="line"><span class="function"></span></div><div class="line"><span class="title">createTrade</span> = <span class="params">(info,req_id,callback)</span> -&gt;</div><div class="line">	sql = <span class="string">"insert into alipay_trades(user,req_id,create_time) values(?,?,now())"</span> </div><div class="line">	db.queryAll sql,[info.user_id,req_id],<span class="function"><span class="params">(err,result)</span> -&gt;</span></div><div class="line">		callback err, result?.insertId</div><div class="line"><span class="function">		</span></div><div class="line"><span class="title">storeTradeInfo</span> = <span class="params">(tradeId,rmb,token,callback)</span> -&gt;</div><div class="line">	sql = <span class="string">"update alipay_trades set rmb=?,token=?,state='WAIT_PAY' where id = ?"</span></div><div class="line">	args = [rmb,token,tradeId]</div><div class="line">	db.queryAll sql,args,<span class="function"><span class="params">(err,updateResult)</span> -&gt;</span></div><div class="line">		callback err,updateResult?.affectedRows <span class="keyword">is</span> <span class="number">1</span></div></pre></td></tr></table></figure>
<h4 id="5-3-2-通知-notify"><a href="/2013/支付宝WAP支付接口开发/#5-3-2-通知-notify" class="headerlink" title="5.3.2 通知(notify)"></a>5.3.2 通知(notify)</h4><p>用户支付后就等着通知了，按道理应该在TRADE_SUCCESS时处理用户支付成功的逻辑，但我实际测试发现至发送了TRADE_FINISHED事件来，所以干脆两个一并处理了，反正只会有一次成功。</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">xmlreader = <span class="built_in">require</span> <span class="string">'xmlreader'</span>rr,updateResult?.affectedRows <span class="keyword">is</span> <span class="number">1</span></div><div class="line">demo.onNotify = <span class="function"><span class="params">(req,callback)</span> -&gt;</span></div><div class="line">	xmlreader.read req.notify_data,<span class="function"><span class="params">(err,xdoc)</span> -&gt;</span></div><div class="line">		<span class="keyword">return</span> done err <span class="keyword">if</span> err</div><div class="line">		notify = xdoc.notify</div><div class="line">		notify_id = notify?.notify_id?.text()</div><div class="line">		<span class="keyword">return</span> done <span class="string">'bad notify_data'</span> <span class="keyword">unless</span> notify_id</div><div class="line"><span class="function">		<span class="title">done</span> = <span class="params">(response)</span> -&gt;</span></div><div class="line">			<span class="keyword">unless</span> <span class="string">'string'</span> <span class="keyword">is</span> <span class="keyword">typeof</span> response</div><div class="line">				<span class="built_in">console</span>.error <span class="string">"response notify error: "</span> + (response?.stack ? response ? <span class="string">''</span>)</div><div class="line">				response = <span class="string">'server error'</span></div><div class="line">			<span class="built_in">console</span>.error <span class="string">"response notify: <span class="subst">#&#123;response&#125;</span>"</span> <span class="keyword">unless</span> response <span class="keyword">is</span> <span class="string">'success'</span></div><div class="line">			storeNotifyResponse notify_id,response, <span class="function"><span class="params">(err)</span> -&gt;</span></div><div class="line">				callback <span class="keyword">if</span> response <span class="keyword">is</span> <span class="string">'success'</span> <span class="keyword">then</span> err <span class="keyword">else</span> response</div><div class="line">		storeNotifyDetails notify_id, notify, req, <span class="function"><span class="params">(err,success)</span> -&gt;</span></div><div class="line">			<span class="keyword">return</span> done err <span class="keyword">if</span> err</div><div class="line">			<span class="keyword">unless</span> success</div><div class="line">				<span class="keyword">return</span> done <span class="string">"store detail error"</span></div><div class="line">			trade_status = notify.trade_status.text()</div><div class="line">			<span class="keyword">if</span> trade_status <span class="keyword">is</span> <span class="string">'TRADE_FINISHED'</span> <span class="keyword">or</span> trade_status <span class="keyword">is</span> <span class="string">'TRADE_SUCCESS'</span></div><div class="line">				<span class="keyword">unless</span> req.sign <span class="keyword">is</span> api.getNotitySign req</div><div class="line">					<span class="keyword">return</span> done <span class="string">'bad sign'</span></div><div class="line">				out_trade_no = notify.out_trade_no.text()</div><div class="line">				getTradeUser out_trade_no,<span class="function"><span class="params">(err,user)</span> -&gt;</span></div><div class="line">					<span class="keyword">return</span> done err <span class="keyword">if</span> err</div><div class="line">					user_id = user?.user</div><div class="line">					<span class="keyword">return</span> done <span class="string">'unknown user'</span> <span class="keyword">unless</span> user_id</div><div class="line">					onPayed user_id,<span class="function"><span class="params">(err,success)</span> -&gt;</span></div><div class="line">						<span class="keyword">return</span> done err <span class="keyword">if</span> err</div><div class="line">						<span class="keyword">return</span> done <span class="string">"onPayed error"</span> <span class="keyword">unless</span> success</div><div class="line">						storeTradeFinalState out_trade_no, <span class="literal">no</span>, <span class="built_in">console</span>.error</div><div class="line">						done <span class="string">'success'</span></div><div class="line">			<span class="keyword">else</span> <span class="comment"># TRADE_PENDING, TRADE_CLOSED, WAIT_BUYER_PAY, etc </span></div><div class="line">				<span class="keyword">return</span> done <span class="string">'unknown trade status'</span></div></pre></td></tr></table></figure>
<p>跟存储相关的几个方法如下：</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">storeTradeFinalState</span> = <span class="params">(tradeId,isError,callback)</span> -&gt;</span></div><div class="line">	state = <span class="keyword">if</span> isError <span class="keyword">then</span> <span class="string">'FAILURE'</span> <span class="keyword">else</span> <span class="string">'SUCCESS'</span></div><div class="line">	sql = <span class="string">"update alipay_trades set state=?,close_time=now() where id = ?"</span></div><div class="line">	args = [state,tradeId]</div><div class="line">	db.queryAll sql,args,<span class="function"><span class="params">(err,updateResult)</span> -&gt;</span></div><div class="line">		callback err,updateResult?.affectedRows <span class="keyword">is</span> <span class="number">1</span></div><div class="line"><span class="function"></span></div><div class="line"><span class="title">getTradeUser</span> = <span class="params">(out_trade_no,callback)</span> -&gt;</div><div class="line">	sql = <span class="string">"select id,user from alipay_trades where id=?"</span></div><div class="line">	db.queryOne sql,[out_trade_no],callback</div><div class="line"><span class="function"></span></div><div class="line"><span class="title">onPayed</span> = <span class="params">(user_id,callback)</span> -&gt;</div><div class="line">	sql = <span class="string">"update users set vip=1 where id=? and vip=0 limit 1"</span></div><div class="line">	db.queryAll sql,[user_id],<span class="function"><span class="params">(err,updateResult)</span> -&gt;</span></div><div class="line">		callback err, updateResult?.affectedRows <span class="keyword">is</span> <span class="number">1</span></div><div class="line"><span class="function"></span></div><div class="line"><span class="title">storeNotifyDetails</span> = <span class="params">(notify_id,notify,raw,callback)</span> -&gt;</div><div class="line">	sql = <span class="string">"insert ignore into alipay_notifies(id,recv_time,subject,trade_no,gmt_create,</span></div><div class="line"> 		quantity,out_trade_no,notify_time,total_fee,buyer_email,trade_status, </div><div class="line">  		gmt_payment,gmt_close,raw) values(?,now(),?,?,?,?,?,?,?,?,?,?,?,? )"</div><div class="line">	args = [</div><div class="line">		notify_id,</div><div class="line">		notify.subject?.text()</div><div class="line">		notify.trade_no?.text()</div><div class="line">		notify.gmt_create?.text()</div><div class="line">		notify.quantity?.text()</div><div class="line">		notify.out_trade_no?.text()</div><div class="line">		notify.notify_time?.text()</div><div class="line">		notify.total_fee?.text()</div><div class="line">		notify.buyer_email?.text()</div><div class="line">		notify.trade_status?.text()</div><div class="line">		notify.gmt_payment?.text()</div><div class="line">		notify.gmt_close?.text()</div><div class="line">		JSON.stringify raw</div><div class="line">	]</div><div class="line">	db.queryAll sql,args,<span class="function"><span class="params">(err,updateResult)</span> -&gt;</span></div><div class="line">		callback err,updateResult?.affectedRows <span class="keyword">is</span> <span class="number">1</span> </div><div class="line"><span class="function"></span></div><div class="line"><span class="title">storeNotifyResponse</span> = <span class="params">(notify_id,response,done)</span> -&gt;</div><div class="line">	sql = <span class="string">"update alipay_notifies set response=? where id=?"</span></div><div class="line">	db.queryAll sql,[response,notify_id],done</div></pre></td></tr></table></figure>
<h2 id="6-后记"><a href="/2013/支付宝WAP支付接口开发/#6-后记" class="headerlink" title="6. 后记"></a>6. 后记</h2><p>有些公司有自己的支付平台，封装了一层，结果调用流程变成下面这样：</p>
<p><img src="http://neutra-blog-images.qiniudn.com/20130728122700.png" alt=""></p>
<blockquote>
<p>Alipay WAP using platform pay flow</p>
<p>Browzer-&gt;+Site: 1. HTTP GET note over Site: 2. create a new trade<br>Site-&gt;-Browzer: 3. trade info Browzer-&gt;+Platform: 4. redirect note<br>over Platform: 5. create a new trade Platform-&gt;+Alipay: 6. create<br>redirect Alipay-&gt;-Platform: 7. Token note over Platform: 8. build auth<br>url Platform-&gt;-Browzer: 9. redirect to auth url Browzer-&gt;Alipay: 10.<br>redirect Alipay-&gt;Browzer: 11. trade info Browzer-&gt;Alipay: 12. auth and<br>pay Alipay-&gt;+Platform: 13. HTTP POST notify Platform-&gt;Site: 14. proxy<br>note over Site: 15. process trade Site-&gt;Platform: 16. reply “success”<br>Platform-&gt;-Alipay: 17. reply “success” Alipay-&gt;Browzer: 18. pay<br>success Browzer-&gt;Site: 19. goto return url</p>
</blockquote>
<p>咋一看，挺方便的，Site只需要做个跳转即可，细节都被Platform隐藏起来了，切换不同的支付方式也变得很方便。</p>
<p>可是，这个平台的接口并不完善，这些数据都是明文并且没有要求Site做签名，于是就有一个风险。跟(2)的流程图对比，可以发现这个流程多了（3,4,14,16）四个步骤。后面两步只是个代理包装，没什么问题，问题在于步骤3和4。</p>
<p>可以看到，交易细节被放到了重定向url中了，即用户可以得知交易内容并篡改里面的数据。举个例子，假设重定向地址类似这样</p>
<blockquote>
<p><a href="http://payment.mysite.com/api/pay?tradeno=10000&amp;rmb=100.00&amp;siteid=1" target="_blank" rel="external">http://payment.mysite.com/api/pay?tradeno=10000&amp;rmb=100.00&amp;siteid=1</a></p>
</blockquote>
<p>由于该地址没有验签机制，所以攻击者很容易就可以发现这里面可以随意篡改数据。</p>
<p>方法1： 将rmb=100.00改成0.01，即将100元的支付变成1分钱，然后支付。结果Site得到通知的时候，就需要额外处理这种支付款项和要求款项不一致的情况。当然最简单就是金额不足就不退款并且支付失败了。假如没做这种判断，那就相当把100元的商品以1分钱卖出去了。</p>
<p>方法2： 伪造大量tradeno，然后请求，并且不支付款项。由于tradeno要求唯一，并只能使用一次，这样就相当于消耗掉了site的交易ID，并且site对此毫不知情。结果正常用户要购买时，创建的订单号对于site来说是未使用的，但对platform来说已经是使用过了，会返回支付失败。</p>
<p>要避免这个问题，需要在重定向的地址增加签名，签名异常的请求都抛弃掉。</p>
<p>（全文完）</p>

          </section>
        </article>
        

       
        <div class="pager">
          
            <a class="post-prev pager-item" href="/2013/赋值表达式的值/" >
              <strong class="article-nav-caption">上一篇</strong>
              <p class="post-nav-title">赋值表达式的值</p>
            </a>
          
          
            <a class="post-next pager-item" href="/2013/如果把A.new()编译成new A()/">
              <strong class="article-nav-caption">下一篇</strong>
              <p class="post-nav-title">如果把A.new()编译成new A()</p>
            </a>
          
        </div>
        

         <!-- comments -->
        <div class="comment-section">
  
    

    <!-- 多说评论框 start -->
      <div class="ds-thread" data-thread-key="_posts/2013-07-02-支付宝WAP支付接口开发.md" data-title="支付宝WAP支付接口开发" data-url="http://neutra.github.io/2013/支付宝WAP支付接口开发/"></div>
    <!-- 多说评论框 end -->
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
      <script type="text/javascript">
      var duoshuoQuery = {short_name:"neutra"};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
      </script>
    <!-- 多说公共JS代码 end -->

  


</div>

    </div>
    
    <aside>
        <div id="toc">
        </div>
    </aside>
    
</div>

                </div>
            </div>
        </div>
        <footer class="footer">
    <p>由<a href="http://hexo.io/" target="_blank">Hexo</a>强力驱动，搭载<a href="https://github.com/wayou/hexo-theme-gstyle">gstyle</a>主题</p>
    <p>
        &copy; 2016 neutra
    </p>
</footer>
<script src="/lib/jquery.js"></script>
<script src="/lib/waves.js"></script>
<script src="/lib/jquery-ui.js"></script>
<script src="/lib/jquery.tocify.js"></script>
<script src="/js/main.js"></script>

    </body>
</html>
